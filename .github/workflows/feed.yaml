name: Deploy Feed Service

on:
  workflow_call:
    secrets: inherit

jobs:
  feed:
    runs-on: ubuntu-latest
    env:
      REGISTRY: registry.cn-shenzhen.aliyuncs.com/muxi
      IMAGE_TAG: latest
      SSH_HOST: ${{ secrets.SERVER_ADDR }}
      SSH_USER: ${{ secrets.SERVER_USER }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Aliyun Registry
        uses: docker/login-action@v2
        with:
          registry: registry.cn-shenzhen.aliyuncs.com
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: Build & push forum_be_feed via Makefile
        run: |
          SERVICE=feed REGISTRY=$REGISTRY IMAGE_TAG=$IMAGE_TAG make docker-build
          SERVICE=feed REGISTRY=$REGISTRY IMAGE_TAG=$IMAGE_TAG make docker-push

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: SSH into server and deploy
        run: |
          echo "Will deploy: forum_be_feed"
          ssh -i ~/.ssh/id_rsa \
              -o StrictHostKeyChecking=no \
              ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_ADDR }} bash -s <<EOF
          echo "SSH Success!"
          cd ~/forum
          REGISTRY=${{ env.REGISTRY }}
          IMAGE_TAG=${{ env.IMAGE_TAG }}
          SERVICE=forum_be_feed
          IMAGE=\$REGISTRY/\$SERVICE:\$IMAGE_TAG
          echo "» Deploying \$SERVICE → \$IMAGE"
          docker rm -f \$SERVICE || true
          docker pull \$IMAGE || true
          docker rmi -f \$IMAGE || true
          IMAGE=\$IMAGE docker-compose up -d \$SERVICE
          EOF
